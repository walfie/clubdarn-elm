<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClubDarn</title>

</head>
<body>

<script src="target/clubdarn.js"></script>
<script>
var ClubDarn = (function() {
  var settingsKey = 'settings';

  // Initialize settings from localStorage
  var settingsJson = localStorage.getItem(settingsKey);
  var settings = null;
  try { settings = JSON.parse(settingsJson) } catch (e) {};

  var flags = {
    apiBaseUrl: 'http://localhost:8000/api',
    settings: settings
  };

  var app = Elm.ClubDarn.Main.fullscreen(flags);

  app.ports.saveSettings.subscribe(function(settings) {
    localStorage.setItem(settingsKey, JSON.stringify(settings));
  });

  app.ports.selectFile.subscribe(function(elementId) {
    var input = document.getElementById(elementId);
    var totalItems = input.files.length;

    function handledFile(maybeMetadata) {
      app.ports.fileMetadata.send({
        result: maybeMetadata,
        total: totalItems
      });
    }

    for (var i = 0; i < totalItems; i++) {
      var file = input.files[i];
      jsmediatags.read(file, {
        onSuccess: function(result) {
          var tags = result.tags || {};
          var metadata = {
            title: tags.title || '',
            artist: tags.artist || ''
          };

          handledFile(metadata);
        },
        onError: function(e) {
          console.error(e);
          handledFile(null);
        }
      });
    }

    if (totalItems <= 0) {
      totalItems = 1;
      handledFile(null);
    }
  });

  return app;
}());
</script>

<link rel="stylesheet" href="assets/style.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script async src="https://rawgit.com/aadsm/jsmediatags/master/dist/jsmediatags.min.js"></script>

</body>
</html>
